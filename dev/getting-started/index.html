<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Getting started · PostgresORM documentation</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">PostgresORM documentation</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Index</a></li><li class="is-active"><a class="tocitem" href>Getting started</a><ul class="internal"><li><a class="tocitem" href="#Pre-requisites"><span>Pre-requisites</span></a></li><li><a class="tocitem" href="#Example-projects"><span>Example projects</span></a></li><li><a class="tocitem" href="#Concepts"><span>Concepts</span></a></li><li><a class="tocitem" href="#Design-choices"><span>Design choices</span></a></li><li><a class="tocitem" href="#Reverse-engineer-the-database"><span>Reverse engineer the database</span></a></li><li><a class="tocitem" href="#How-to-record-changes"><span>How to record changes</span></a></li></ul></li><li><span class="tocitem">Modules</span><ul><li><a class="tocitem" href="../modules/PostgresORM/">Module PostgresORM</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Getting started</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Getting started</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaPostgresORM/PostgresORM.jl/blob/master/docs/src/getting-started.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Getting-started"><a class="docs-heading-anchor" href="#Getting-started">Getting started</a><a id="Getting-started-1"></a><a class="docs-heading-anchor-permalink" href="#Getting-started" title="Permalink"></a></h1><h2 id="Pre-requisites"><a class="docs-heading-anchor" href="#Pre-requisites">Pre-requisites</a><a id="Pre-requisites-1"></a><a class="docs-heading-anchor-permalink" href="#Pre-requisites" title="Permalink"></a></h2><h3 id="Install-LibPQ.jl"><a class="docs-heading-anchor" href="#Install-LibPQ.jl">Install LibPQ.jl</a><a id="Install-LibPQ.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Install-LibPQ.jl" title="Permalink"></a></h3><p><code>(MyProject) pkg&gt; add LibPQ</code></p><h3 id="Install-PostgresORM.jl"><a class="docs-heading-anchor" href="#Install-PostgresORM.jl">Install PostgresORM.jl</a><a id="Install-PostgresORM.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Install-PostgresORM.jl" title="Permalink"></a></h3><p><code>(MyProject) pkg&gt; add PostgresORM</code></p><h2 id="Example-projects"><a class="docs-heading-anchor" href="#Example-projects">Example projects</a><a id="Example-projects-1"></a><a class="docs-heading-anchor-permalink" href="#Example-projects" title="Permalink"></a></h2><p>You can look at the following projects to see how PostgresORM is used :</p><ul><li><a href="https://github.com/JuliaPostgresORM/IMDBTestApp.jl">IMDBTestApp.jl</a></li></ul><h2 id="Concepts"><a class="docs-heading-anchor" href="#Concepts">Concepts</a><a id="Concepts-1"></a><a class="docs-heading-anchor-permalink" href="#Concepts" title="Permalink"></a></h2><h3 id="Classes"><a class="docs-heading-anchor" href="#Classes">Classes</a><a id="Classes-1"></a><a class="docs-heading-anchor-permalink" href="#Classes" title="Permalink"></a></h3><p>PostgreSQL tables are mapped to mutable composite types that inherit the abstract type PostgresORM.IEntity.</p><p>For the sake of conciseness we call this particular type a <em>class</em>.</p><p>A <em>class</em> looks like this :</p><pre><code class="nohighlight hljs">mutable struct Film &lt;: IFilm

  id::Union{Missing,Int32}
  codeName::Union{Missing,String}
  year::Union{Missing,Int16}
  actorFilmAssos::Union{Missing,Vector{Model.IActorFilmAsso}}

  Film(args::NamedTuple) = Film(;args...)
  Film(;
    id = missing,
    codeName = missing,
    year = missing,
    actorFilmAssos = missing,
  ) = (
    x = new(missing,missing,missing,missing,);
    x.id = id;
    x.codeName = codeName;
    x.year = year;
    x.actorFilmAssos = actorFilmAssos;
    return x
  )

end</code></pre><p>Lets describe the key aspects of a <em>class</em>:</p><h4 id="A-*class*-inherits-an-abstract-type-that-inherits-IEntity"><a class="docs-heading-anchor" href="#A-*class*-inherits-an-abstract-type-that-inherits-IEntity">A <em>class</em> inherits an abstract type that inherits IEntity</a><a id="A-*class*-inherits-an-abstract-type-that-inherits-IEntity-1"></a><a class="docs-heading-anchor-permalink" href="#A-*class*-inherits-an-abstract-type-that-inherits-IEntity" title="Permalink"></a></h4><p><code>mutable struct Film &lt;: IFilm</code> where <code>IFilm &lt;: PostgresORM.IEntity</code></p><p>This allows us to avoid circular dependencies</p><h4 id="Fields-of-a-class-are-all-Union-of-a-Missing-and-something-else"><a class="docs-heading-anchor" href="#Fields-of-a-class-are-all-Union-of-a-Missing-and-something-else">Fields of a class are all Union of a Missing and something else</a><a id="Fields-of-a-class-are-all-Union-of-a-Missing-and-something-else-1"></a><a class="docs-heading-anchor-permalink" href="#Fields-of-a-class-are-all-Union-of-a-Missing-and-something-else" title="Permalink"></a></h4><p><code>id::Union{Missing,Int32}</code></p><p>The &#39;something else&#39; can be a lot of things including a <code>IEntity</code> or a vector of <code>IEntity</code>.</p><p>In this documentation we call:</p><p>A &#39;<em>complex property</em>&#39;, a property of type <code>IEntity</code>. It is also named a &quot;manyToOne&quot; property and it resolves to a foreign key in the table of the   <em>class</em>.</p><p>A &#39;<em>property of IEntities</em>&#39;, a property of type <code>Vector{T} where T &lt;: IEntity</code>.   It is also named a &quot;oneToMany&quot; property and it is the counter part of a <em>complex property</em> in another <em>class</em>.</p><h4 id="A-*class*-has-two-constructors"><a class="docs-heading-anchor" href="#A-*class*-has-two-constructors">A <em>class</em> has two constructors</a><a id="A-*class*-has-two-constructors-1"></a><a class="docs-heading-anchor-permalink" href="#A-*class*-has-two-constructors" title="Permalink"></a></h4><p>A first constructor that takes a NamedTuple and that is required by PostgresORM function. It calls the second constructor by splatting the NamedTuple.</p><p>A second constructor that takes optional named arguments with default values   <code>missing</code> and that assign the values to the matching properties.</p><p>Therefore:</p><p>Calling <code>Film()</code> creates an instance of <em>Film</em> with all properties set to <code>missing</code></p><p>Calling <code>Film(id = 34, codeName = &quot;cube&quot;)</code> creates an instance of <em>Film</em> with all properties set to <code>missing</code> except <em>id</em> and <em>codeName</em></p><h3 id="ORM-modules"><a class="docs-heading-anchor" href="#ORM-modules">ORM modules</a><a id="ORM-modules-1"></a><a class="docs-heading-anchor-permalink" href="#ORM-modules" title="Permalink"></a></h3><p>An ORM module is a Julia module that tells PostgresORM how to handle a <em>class</em>. It contains the following:</p><p><code>data_type = Model.Film</code>: Assigns the module variable <code>data_type</code> to the   <em>class</em> associated with the ORM module</p><p><code>PostgresORM.get_orm(x::Model.Film) = return(ORM.FilmORM)</code>: Declares a new   method of function <code>PostgresORM.get_orm</code>, this function is used to tell   PostgresORM which ORM module to use for a given <em>class</em></p><p><code>get_schema_name() = &quot;public&quot;</code>: Returns the PostgreSQL schema name of the table associated with the <em>class</em></p><p><code>get_table_name() = &quot;film&quot;</code>: Returns the table name associated with the <em>class</em>  </p><p><code>get_columns_selection_and_mapping()</code>: Returns the mapping between julia   fields and table columns. Note that  a <em>complex property</em> can be mapped to   an array of columns if the foreign key has multiple columns (i.e. if the   <em>class</em> of the <em>complex</em>property_ has a composite id)</p><p><code>get_id_props()</code>: Returns the fields that make the id of the <em>class</em>. These   fields can be <em>complex properties</em></p><p><code>get_onetomany_counterparts()</code>: It gives for every <em>property of IEntities</em>     the associated <em>complex property</em> (i.e. manyToOne property)</p><p><code>get_types_override()</code>: It gives for every oneToMany or manyToOne property   the real type of the property</p><p><strong>Some optional functions for the tracking of changes:</strong></p><p><code>get_track_changes()</code>: Tells PostgresORM to record all the changes made to   instances of the <em>class</em></p><p><code>get_creator_property()</code>: Tells which property holds the reference of the   user that created the instance. This property must inherit <code>PostgresORM.AppUser</code></p><p><code>get_editor_property()</code>: Tells which property holds the reference of the   user that last edited the instance. This property must inherit <code>PostgresORM.AppUser</code></p><p><code>get_creation_time_property()</code>: Tells which property holds the creation   time of the instance</p><p><code>get_update_time_property()</code>: Tells which property holds the last update   time of the instance</p><h3 id="Enums"><a class="docs-heading-anchor" href="#Enums">Enums</a><a id="Enums-1"></a><a class="docs-heading-anchor-permalink" href="#Enums" title="Permalink"></a></h3><p>Julia enums are the counterpart of PostgreSQL custom enumeration types.</p><h3 id="LibPQ-connection"><a class="docs-heading-anchor" href="#LibPQ-connection">LibPQ connection</a><a id="LibPQ-connection-1"></a><a class="docs-heading-anchor-permalink" href="#LibPQ-connection" title="Permalink"></a></h3><p>Many PostgresORM functions expects a <code>LibPQ.Connection</code> as one of the arguments. The developer is in charge of managing the connections and the transactions.</p><h2 id="Design-choices"><a class="docs-heading-anchor" href="#Design-choices">Design choices</a><a id="Design-choices-1"></a><a class="docs-heading-anchor-permalink" href="#Design-choices" title="Permalink"></a></h2><h3 id="Retrieval-of-*complex-properties*"><a class="docs-heading-anchor" href="#Retrieval-of-*complex-properties*">Retrieval of <em>complex properties</em></a><a id="Retrieval-of-*complex-properties*-1"></a><a class="docs-heading-anchor-permalink" href="#Retrieval-of-*complex-properties*" title="Permalink"></a></h3><p>Methods <code>retrieve_entity</code> and <code>retrieve_one_entity</code> expects the argument <code>retrieve_complex_props</code> to tell them if they need to make additional queries to retrieve the properties of the <em>complex properties</em>. If <code>retrieve_complex_props == false</code> then the properties of a <em>complex</em>property_ will be set to missing except the properties used as IDs.</p><h3 id="Retrieval-of-*properties-of-IEntities*"><a class="docs-heading-anchor" href="#Retrieval-of-*properties-of-IEntities*">Retrieval of <em>properties of IEntities</em></a><a id="Retrieval-of-*properties-of-IEntities*-1"></a><a class="docs-heading-anchor-permalink" href="#Retrieval-of-*properties-of-IEntities*" title="Permalink"></a></h3><p>Reminder, methods <code>retrieve_entity</code> and <code>retrieve_one_entity</code> expects the argument <code>retrieve_complex_props</code> to tell them if they need to make additional queries to retrieve the properties of the  <em>complex properties</em>. There is no such thing for <em>properties of IEntities</em>, PostgresORM never loads them (the properties of will be equal to missing). It is up to the package user to enrich the instance if he wants to.</p><h3 id="Update-of-a-*properties-of-IEntities*"><a class="docs-heading-anchor" href="#Update-of-a-*properties-of-IEntities*">Update of a <em>properties of IEntities</em></a><a id="Update-of-a-*properties-of-IEntities*-1"></a><a class="docs-heading-anchor-permalink" href="#Update-of-a-*properties-of-IEntities*" title="Permalink"></a></h3><p><code>update_entity</code> does not update properties of type vector of IEntities. If the user wants to update a property of type vector of IEntities, he needs to use <code>update_vector_property!</code>.</p><h3 id="Beware!-missing-has-two-meanings"><a class="docs-heading-anchor" href="#Beware!-missing-has-two-meanings">Beware! missing has two meanings</a><a id="Beware!-missing-has-two-meanings-1"></a><a class="docs-heading-anchor-permalink" href="#Beware!-missing-has-two-meanings" title="Permalink"></a></h3><p>A property with value missing can mean that:</p><ul><li>the value is missing for this entity</li><li>the value has not been loaded yet</li></ul><p>We could have make use of <code>Nothing</code> for the second case but we decided not to because the benefit was too small compare to the complexity it was adding. Nevertheless, the developer must be well aware of this when updating an instance. Here are two code snippets to show what is the risk:</p><pre><code class="nohighlight hljs">  # Load the film with retrieve_complex_props set to true
  film = retrieve_one_entity(Film(codeName = &quot;cube&quot;),
                             true, # retrieve the complex props
                             dbconn)
  @test ismissing(film.director.id) # false
  @test ismissing(film.director.birthDate) # false
  update_entity(film.director, dbconn) # This is OK


  # Load the film with retrieve_complex_props set to false
  film = retrieve_one_entity(Film(codeName = &quot;cube&quot;),
                             false, # do not retrieve the complex props
                             dbconn)
  @test ismissing(film.director.id) # false
  @test ismissing(film.director.birthDate) # true
  update_entity(film.director, dbconn) # This is NOT OK! the director will loose
                                       #   its birthDate

</code></pre><h2 id="Reverse-engineer-the-database"><a class="docs-heading-anchor" href="#Reverse-engineer-the-database">Reverse engineer the database</a><a id="Reverse-engineer-the-database-1"></a><a class="docs-heading-anchor-permalink" href="#Reverse-engineer-the-database" title="Permalink"></a></h2><p>The easiest way to get started is to ask PostgresORM to generate the <em>classes</em>, the ORM modules and the enums. Once done, you can copy the files in the <em>src</em> folder of the project and declare everything in the project (see how it&#39;s done in <a href="https://github.com/JuliaPostgresORM/IMDBTestApp.jl">IMDBTestApp.jl</a>).</p><p>Here is an example of script to reverse engineer a database:</p><pre><code class="nohighlight hljs">out_dir = (@__DIR__) * &quot;/out&quot;
dbconn = begin
    database = &quot;imdbtestapp&quot;
    user = &quot;imdbtestapp&quot;
    host = &quot;127.0.0.1&quot;
    port = &quot;5432&quot;
    password = &quot;1234&quot;

    LibPQ.Connection(&quot;host=$(host)
                      port=$(port)
                      dbname=$(database)
                      user=$(user)
                      password=$(password)
                      &quot;; throw_error=true)
    end
PostgresORM.Tool.generate_julia_code(dbconn,out_dir)

close(dbconn)</code></pre><h2 id="How-to-record-changes"><a class="docs-heading-anchor" href="#How-to-record-changes">How to record changes</a><a id="How-to-record-changes-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-record-changes" title="Permalink"></a></h2><h3 id="Record-the-changes-in-the-modified-class-itself"><a class="docs-heading-anchor" href="#Record-the-changes-in-the-modified-class-itself">Record the changes in the modified class itself</a><a id="Record-the-changes-in-the-modified-class-itself-1"></a><a class="docs-heading-anchor-permalink" href="#Record-the-changes-in-the-modified-class-itself" title="Permalink"></a></h3><p>You can ask PostgresORM to record the following information inside the class itself :</p><ul><li>the creator of an instance,</li><li>the last editor of an instance,</li><li>the creation time  of an instance,</li><li>the last edition time  of an instance</li></ul><p>To do this you need to declare the following functions in the ORM of the class:</p><pre><code class="nohighlight hljs">get_creator_property() = :your_creator_prop
get_editor_property() = :your_lastEditor_prop
get_creation_time_property() = :your_creationTime_prop
get_update_time_property() = :your_updateTime_prop</code></pre><p>NOTE: You can decide to only declare some of these functions</p><h3 id="Record-the-changes-in-a-&#39;modification&#39;-table"><a class="docs-heading-anchor" href="#Record-the-changes-in-a-&#39;modification&#39;-table">Record the changes in a &#39;modification&#39; table</a><a id="Record-the-changes-in-a-&#39;modification&#39;-table-1"></a><a class="docs-heading-anchor-permalink" href="#Record-the-changes-in-a-&#39;modification&#39;-table" title="Permalink"></a></h3><p>You can also ask PostgresORM to record the details of the modifications of a class in a table.</p><p>To do this you need:</p><ul><li>Tell the ORM of the class that you want to record the changes</li><li>A table where to write those modifications</li></ul><h4 id="Declare-the-following-functions-in-the-ORM-of-the-class:"><a class="docs-heading-anchor" href="#Declare-the-following-functions-in-the-ORM-of-the-class:">Declare the following functions in the ORM of the class:</a><a id="Declare-the-following-functions-in-the-ORM-of-the-class:-1"></a><a class="docs-heading-anchor-permalink" href="#Declare-the-following-functions-in-the-ORM-of-the-class:" title="Permalink"></a></h4><pre><code class="nohighlight hljs">get_track_changes() = true</code></pre><h4 id="The-Modification-table"><a class="docs-heading-anchor" href="#The-Modification-table">The <code>Modification</code> table</a><a id="The-Modification-table-1"></a><a class="docs-heading-anchor-permalink" href="#The-Modification-table" title="Permalink"></a></h4><p>PostgresORM ships a class <code>Modification</code> that inherits from <code>IEntity</code>. It also has the accompanying ORM mapping module <code>PostgresORM.ModificationORM</code>. By default, this class is serialized to a table <code>modification</code> in the schema <code>public</code>.</p><p>Here is the SQL for the creation of the table if you want to use the default mapping of ModificationORM:</p><pre><code class="nohighlight hljs">CREATE TABLE public.modification
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    entity_type character varying COLLATE pg_catalog.&quot;default&quot;,
    entity_id character varying COLLATE pg_catalog.&quot;default&quot;,
    attrname character varying COLLATE pg_catalog.&quot;default&quot;,
    oldvalue text COLLATE pg_catalog.&quot;default&quot;,
    user_id character varying COLLATE pg_catalog.&quot;default&quot;,
    newvalue text COLLATE pg_catalog.&quot;default&quot;,
    action_id uuid,
    action_type character varying(10) COLLATE pg_catalog.&quot;default&quot;,
    creation_time timestamp without time zone,
    CONSTRAINT modification_pkey PRIMARY KEY (id)
)</code></pre><p>Suppose the modification table is in a different schema, you can tell PostgresORM where it is by overwriting the functions of <code>PostgresORM.ModificationORM</code>. Eg.</p><pre><code class="nohighlight hljs">PostgresORM.ModificationORM.get_schema_name() = &quot;my_schema&quot;</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Index</a><a class="docs-footer-nextpage" href="../modules/PostgresORM/">Module PostgresORM »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.13 on <span class="colophon-date" title="Friday 25 February 2022 11:26">Friday 25 February 2022</span>. Using Julia version 1.6.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
